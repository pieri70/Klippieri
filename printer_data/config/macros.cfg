######################################
# Macro per estrusori
######################################

[gcode_macro LOAD_FILAMENT]
variable_load_distance: 100         # Distance to load filament into the extruder
variable_purge_distance: 50         # Distance to purge filament after loading
variable_nozzle_preheat_temp: 230   # Default preheat temperature for the nozzle
variable_turn_off_extruder: True    # Option to turn off the extruder after loading (True/False)
variable_extruder_n: "T0"             # Default extruder selector

gcode:
    # Parameters and settings
    {% set load_speed = params.LOAD_SPEED|default(600) %}
    {% set purge_speed = params.PURGE_SPEED|default(300) %}
    {% set target_temp = params.TARGET_TEMP|default(nozzle_preheat_temp) %}
    {% set min_temp = params.MIN_TEMP|default(180) %}

    SAVE_GCODE_STATE NAME=load_state

    {% if extruder_n %}
        {extruder_n}
    {% else %}
        T0
    {% endif %}

    {% if target_temp >= min_temp %}
        M104 S{target_temp}
        M109 S{target_temp}
    {% else %}
        M104 S{min_temp}
        M109 S{min_temp}
    {% endif %}

    G1 X-10 Y15 Z20 F6000  ; move to purge position

    G91
    G92 E0

    ; Load filament (7 × 100 mm blocks for 700 mm Bowden)
    {% for i in range(7) %}
        G1 E{load_distance} F{load_speed}
    {% endfor %}

    ; Purge filament a bit
    G1 E{purge_distance} F{purge_speed}

    {% if turn_off_extruder %}
        M104 S0
    {% endif %}

    G90
    RESTORE_GCODE_STATE NAME=load_state
    M117 Filament load complete


[gcode_macro UNLOAD_FILAMENT]
variable_unload_distance: 100      # Distance to retract filament per block
variable_nozzle_preheat_temp: 240  # Default preheat temperature for unloading
variable_purge_distance: 20        # Distance to purge filament before unloading
variable_turn_off_extruder: True   # Option to turn off the extruder after unloading (True/False)
variable_extruder_n: "T0"            # Default extruder selector

gcode:
    # Parameters and settings
    {% set retract_speed = params.RETRACT_SPEED|default(600) %}
    {% set purge_speed = params.PURGE_SPEED|default(200) %}
    {% set target_temp = params.TARGET_TEMP|default(nozzle_preheat_temp) %}
    {% set min_temp = params.MIN_TEMP|default(180) %}

    SAVE_GCODE_STATE NAME=unload_state

    {% if extruder_n %}
        {extruder_n}
    {% else %}
        T0
    {% endif %}

    {% if printer.extruder.temperature < target_temp %}
        {% if target_temp >= min_temp %}
            M104 S{target_temp}
            M109 S{target_temp}
        {% else %}
            M104 S{min_temp}
            M109 S{min_temp}
        {% endif %}
    {% endif %}

    ; Move to unload position
    G90
    G1 X300 Y300 Z100 F6000

    G91
    G92 E0
    ; Purge a little before retract
    G1 E{purge_distance} F{purge_speed}
    G92 E0

    ; Retract filament (8 × 100 mm blocks for 700–800 mm Bowden)
    {% for i in range(8) %}
        G1 E-{unload_distance} F{retract_speed}
    {% endfor %}

    {% if turn_off_extruder %}
        M104 S0
    {% endif %}

    G90
    RESTORE_GCODE_STATE NAME=unload_state

    M117 Filament unload complete


[gcode_macro CHANGE_FILAMENT]
variable_load_distance: 100
variable_unload_distance: 100
variable_total_distance: 700
variable_purge_distance: 20
variable_nozzle_preheat_temp: 230
variable_turn_off_extruder: True
variable_extruder_n: "T0"

gcode:
    {% set load_speed = params.LOAD_SPEED|default(600) %}
    {% set unload_speed = params.UNLOAD_SPEED|default(600) %}
    {% set purge_speed = params.PURGE_SPEED|default(300) %}
    {% set target_temp = params.TARGET_TEMP|default(nozzle_preheat_temp) %}
    {% set min_temp = params.MIN_TEMP|default(180) %}

    {% set num_unload = (total_distance // unload_distance)|int %}
    {% set rem_unload = (total_distance % unload_distance)|int %}
    {% set num_load = (total_distance // load_distance)|int %}
    {% set rem_load = (total_distance % load_distance)|int %}

    SAVE_GCODE_STATE NAME=filament_state

    {% if extruder_n %}
        {extruder_n}
    {% else %}
        T0
    {% endif %}

    {% if printer.extruder.temperature < target_temp %}
        {% if target_temp >= min_temp %}
            M104 S{target_temp}
            M109 S{target_temp}
        {% else %}
            M104 S{min_temp}
            M109 S{min_temp}
        {% endif %}
    {% endif %}

    ; --- UNLOAD ---
    G90
    G1 X300 Y300 Z100 F6000

    G91
    G92 E0
    G1 E{purge_distance} F{purge_speed}
    G92 E0

    {% for i in range(num_unload) %}
        G1 E-{unload_distance} F{unload_speed}
    {% endfor %}
    {% if rem_unload > 0 %}
        G1 E-{rem_unload} F{unload_speed}
    {% endif %}

    M117 Inserire nuovo filamento e premere Resume
    PAUSE

    ; --- LOAD ---
    G90
    G1 X-10 Y15 Z20 F6000

    G91
    G92 E0
    {% for i in range(num_load) %}
        G1 E{load_distance} F{load_speed}
    {% endfor %}
    {% if rem_load > 0 %}
        G1 E{rem_load} F{load_speed}
    {% endif %}

    G1 E{purge_distance} F{purge_speed}

    ; --- Pulizia nozzle su spazzola ---
    G1 Z20 F1500
    G1 X-12 Y20 F6000
    G1 X12 Y22 F4000
    G1 X-12 Y24 F4000
    G1 X12 Y26 F4000
    G1 X-12 Y28 F4000
    G1 X12 Y30 F4000
    G1 X-12 Y32 F4000
    G1 X12 Y34 F4000
    G1 X0 Y35 F4000
    G92 E0

    {% if turn_off_extruder %}
        M104 S0
    {% endif %}

    G90
    RESTORE_GCODE_STATE NAME=filament_state
    M117 Filament change complete


######################################
# Macro per manual bed levelling
######################################
[gcode_macro LEVEL_BED]
gcode:
    BED_SCREWS_ADJUST

######################################
# Macro per Bed Mesh
######################################
[gcode_macro BED_MESH_COREXY_DEFAULT]
description: Calibrazione automatica del bed mesh a 90°C e salvataggio come corexy_default
gcode:
    # Riscaldamento bed
    M140 S90
    M190 S90

    # Homing assi
    G28

    # Calibrazione bed mesh
    BED_MESH_CALIBRATE

    # Salvataggio profilo
    BED_MESH_PROFILE SAVE=corexy_default
    M140 S0
    M117 Bed mesh salvato come corexy_default

[gcode_macro ESEGUI_BED_MESH]
description: Calibrazione automatica del bed mesh a 90°C e salvataggio come corexy_default
gcode:
    # Riscaldamento bed
    M140 S90
    M190 S90

    # Homing assi
    G28

    # Calibrazione bed mesh
    BED_MESH_CALIBRATE

    M117 Bed mesh completata

######################################
# Macro per inizio/fine stampa
######################################
[gcode_macro _PRINT_START]
description: Start stampa con riscaldamento intelligente, pulizia nozzle e caricamento bed mesh
gcode:
    {% set BED_TEMP = params.BED|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER|default(200)|float %}
    {% set BED_TRIGGER = BED_TEMP * 0.8 %}

    # Riscaldamento
    M140 S{BED_TEMP}
    TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={BED_TRIGGER}
    M104 S150
    M190 S{BED_TEMP}
    M109 S{EXTRUDER_TEMP}

    # Homing
    G90
    G28

    # Carica il bed mesh salvato
    BED_MESH_PROFILE LOAD=corexy_default

    # Spurgo e pulizia ugello sulla spazzola
    G92 E0
    G1 X-10 Y15 Z0.3 F6000
    G1 E30 F300
    G92 E0
    G1 Z0.0 F1200
    G1 X0 Y20 F6000
    G1 X10 Y22 F4000
    G1 X-10 Y25 F4000
    G1 X10 Y28 F4000
    G1 X-10 Y31 F4000
    G1 X10 Y34 F4000
    G1 X0 Y35 F4000
    G1 Z5 F1500
    G92 E0

    M117 Inizio stampa...


[gcode_macro _PRINT_END]
description: End stampa Voron 2.4 con retrazione, sollevamento e spegnimento
gcode:
    M400                     ; Attendi completamento buffer
    G92 E0                   ; Azzera estrusore
    G1 E-4.0 F300            ; Retrazione
    G91                      ; Coordinate relative
    G1 Z10 F600              ; Solleva ugello
    G90                      ; Coordinate assolute
    G1 X300 Y300 F5000       ; Parcheggia testina
    M104 S0                  ; Spegni hotend
    M140 S0                  ; Spegni bed
    M106 S0                  ; Spegni ventole
    M84                      ; Disattiva motori
    M117 Stampa completata
    
[gcode_macro PRINT_START]
description: Alias pubblico per _PRINT_START (usato da OrcaSlicer)
gcode:
    _PRINT_START {rawparams}

[gcode_macro PRINT_END]
description: Alias pubblico per _PRINT_END (usato da OrcaSlicer)
gcode:
    _PRINT_END {rawparams}
    