######################################
# Macro per estrusori
######################################

[gcode_macro LOAD_FILAMENT]
variable_load_distance: 100         # Max distanza per blocco (per Klipper)
variable_total_distance: 700        # Lunghezza totale Bowden
variable_purge_distance: 50         # Distanza purge finale
variable_nozzle_preheat_temp: 230   # Default preheat temp
variable_turn_off_extruder: True    # Spegnimento estrusore opzionale
variable_extruder_n: T0             # Estrusore da usare

gcode:
    {% set load_speed = params.LOAD_SPEED|default(600) %}
    {% set purge_speed = params.PURGE_SPEED|default(300) %}
    {% set target_temp = params.TARGET_TEMP|default(nozzle_preheat_temp) %}
    {% set min_temp = params.MIN_TEMP|default(180) %}

    # Calcola numero ripetizioni
    {% set num_repeats = (total_distance // load_distance)|int %}
    {% set remainder = (total_distance % load_distance)|int %}

    # Salva stato
    SAVE_GCODE_STATE NAME=load_state

    # Seleziona estrusore
    {% if extruder_n %}{{extruder_n}}{% else %}T0{% endif %}

    # Riscaldamento estrusore
    {% if target_temp >= min_temp %}
        M104 S{target_temp}
        M109 S{target_temp}
    {% else %}
        M104 S{min_temp}
        M109 S{min_temp}
    {% endif %}

    # --- Posizionamento nozzle per spurgo ---
    G90                  ; coordinate assolute
    G1 X-10 Y15 Z20 F6000

    # Caricamento Bowden
    G91
    G92 E0
    {% for i in range(num_repeats) %}
        G1 E{load_distance} F{load_speed}
    {% endfor %}
    {% if remainder > 0 %}
        G1 E{remainder} F{load_speed}
    {% endif %}

    # Purge finale e pulizia spazzola (zig-zag)
    G1 E{purge_distance} F{purge_speed}
    G1 Z0.0 F1200
    G1 X-12 Y20 F6000
    G1 X12 Y22 F4000
    G1 X-12 Y24 F4000
    G1 X12 Y26 F4000
    G1 X-12 Y28 F4000
    G1 X12 Y30 F4000
    G1 X-12 Y32 F4000
    G1 X12 Y34 F4000
    G1 X0 Y35 F4000
    G1 Z5 F1500
    G92 E0

    # Spegnimento opzionale estrusore
    {% if turn_off_extruder %}
        M104 S0
    {% endif %}

    # Ripristina stato
    G90
    RESTORE_GCODE_STATE NAME=load_state

    M117 Filament load complete

[gcode_macro UNLOAD_FILAMENT]
variable_unload_distance: 100      # Max distanza per blocco (Klipper)
variable_total_distance: 700       # Lunghezza totale Bowden da ritirare
variable_purge_distance: 20        # Purge prima del retratto
variable_nozzle_preheat_temp: 240  # Default preheat temp
variable_turn_off_extruder: True   # Spegnimento opzionale estrusore

gcode:
    {% set retract_speed = params.RETRACT_SPEED|default(600) %}
    {% set purge_speed = params.PURGE_SPEED|default(200) %}
    {% set target_temp = params.TARGET_TEMP|default(nozzle_preheat_temp) %}
    {% set min_temp = params.MIN_TEMP|default(180) %}

    # Calcola quante ripetizioni servono
    {% set num_repeats = (total_distance // unload_distance)|int %}
    {% set remainder = (total_distance % unload_distance)|int %}

    # Salva stato
    SAVE_GCODE_STATE NAME=unload_state

    # Riscaldamento estrusore se necessario
    {% if printer.extruder.temperature < target_temp %}
        {% if target_temp >= min_temp %}
            M104 S{target_temp}
            M109 S{target_temp}
        {% else %}
            M104 S{min_temp}
            M109 S{min_temp}
        {% endif %}
    {% endif %}

    # Posizionamento nozzle al centro piatto e Z=50mm
    G90
    G1 X300 Y300 Z100 F6000  ; Posizione sicura in alto a destra

    # Purge iniziale
    G91
    G92 E0
    G1 E{purge_distance} F{purge_speed}
    G92 E0

    # Retract lungo Bowden
    {% for i in range(num_repeats) %}
        G1 E-{unload_distance} F{retract_speed}
    {% endfor %}
    {% if remainder > 0 %}
        G1 E-{remainder} F{retract_speed}
    {% endif %}

    # Spegnimento opzionale estrusore
    {% if turn_off_extruder %}
        M104 S0
    {% endif %}

    # Ripristina stato
    G90
    RESTORE_GCODE_STATE NAME=unload_state

    M117 Filament unload complete

[gcode_macro CHANGE_FILAMENT]
variable_load_distance: 100
variable_unload_distance: 100
variable_total_distance: 700
variable_purge_distance: 20
variable_nozzle_preheat_temp: 230
variable_turn_off_extruder: True
variable_extruder_n: T0

gcode:
    {% set load_speed = params.LOAD_SPEED|default(600) %}
    {% set unload_speed = params.UNLOAD_SPEED|default(600) %}
    {% set purge_speed = params.PURGE_SPEED|default(300) %}
    {% set target_temp = params.TARGET_TEMP|default(nozzle_preheat_temp) %}
    {% set min_temp = params.MIN_TEMP|default(180) %}

    # --- Salva stato ---
    SAVE_GCODE_STATE NAME=filament_state
    {% if extruder_n %}{{extruder_n}}{% else %}T0{% endif %}

    # --- Riscaldamento estrusore ---
    {% if printer.extruder.temperature < target_temp %}
        {% if target_temp >= min_temp %}
            M104 S{target_temp}
            M109 S{target_temp}
        {% else %}
            M104 S{min_temp}
            M109 S{min_temp}
        {% endif %}
    {% endif %}

    # --- UNLOAD ---
    G90
    G1 X300 Y300 Z100 F6000  ; Posizione sicura in alto a destra
    G91
    G92 E0
    G1 E{purge_distance} F{purge_speed}
    {% set num_repeats = (total_distance // unload_distance)|int %}
    {% set remainder = (total_distance % unload_distance)|int %}
    {% for i in range(num_repeats) %}
        G1 E-{unload_distance} F{unload_speed}
    {% endfor %}
    {% if remainder > 0 %}
        G1 E-{remainder} F{unload_speed}
    {% endif %}

    # --- PAUSA PER INSERIMENTO NUOVO FILAMENTO ---
    M117 Inserire nuovo filamento e premere Resume
    PAUSE

    # --- LOAD ---
    G1 X-10 Y15 Z20 F6000   ; Posizione di caricamento con Z sicura
    G92 E0
    {% for i in range(num_repeats) %}
        G1 E{load_distance} F{load_speed}
    {% endfor %}
    {% if remainder > 0 %}
        G1 E{remainder} F{load_speed}
    {% endif %}

    # Purge finale e zig-zag spazzola
    G1 E{purge_distance} F{purge_speed}
    G1 Z20 F1500
    G1 X-12 Y20 F6000
    G1 X12 Y22 F4000
    G1 X-12 Y24 F4000
    G1 X12 Y26 F4000
    G1 X-12 Y28 F4000
    G1 X12 Y30 F4000
    G1 X-12 Y32 F4000
    G1 X12 Y34 F4000
    G1 X0 Y35 F4000
    G92 E0

    # --- Spegnimento estrusore opzionale ---
    {% if turn_off_extruder %}
        M104 S0
    {% endif %}

    # --- Ripristina stato ---
    G90
    RESTORE_GCODE_STATE NAME=filament_state

    M117 Filament change complete

######################################
# Macro per Bed Mesh
######################################
[gcode_macro BED_MESH_COREXY_DEFAULT]
description: Calibrazione automatica del bed mesh per Voron 2.4, salva come corexy_default
gcode:
    # --- Riscaldamento bed ---
    M140 S90 ; imposta il piatto a 90°C
    M190 S90 ; attendi il piatto a temperatura

    # --- Homing assi ---
    G28 ; home di tutti gli assi

    # --- Calibrazione bed mesh ---
    BED_MESH_CALIBRATE

    # --- Salvataggio profilo ---
    BED_MESH_PROFILE SAVE=corexy_default

    # --- Fine macro ---
    M117 Bed mesh salvato come corexy_default

######################################
# Macro per inizio/fine stampa
######################################
[gcode_macro PRINT_START]
description: Start stampa con riscaldamento intelligente, caricamento mesh e pulizia nozzle ottimizzata
gcode:
    {% set BED_TEMP = params.BED|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER|default(200)|float %}
    {% set BED_TRIGGER = BED_TEMP * 0.8 %}

    # --- Riscaldamento ---
    M140 S{BED_TEMP}                                       ; Avvia riscaldamento del bed
    TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={BED_TRIGGER} ; Attendi 80% target
    M104 S150                                              ; Preriscaldo nozzle a 150°C
    M190 S{BED_TEMP}                                       ; Attendi bed alla temperatura target
    M109 S{EXTRUDER_TEMP}                                  ; Attendi nozzle alla temperatura target

    # --- Homing ---
    G90
    G28

    # --- Caricamento bed mesh salvato ---
    BED_MESH_PROFILE LOAD=corexy_default

    # --- Spurgo iniziale ---
    G92 E0
    G1 X-10 Y15 Z0.3 F6000
    G1 E30 F300
    G92 E0

    # --- Pulizia nozzle sulla spazzola (zig-zag ottimizzato) ---
    G1 Z0.0 F1200           ; quota per spazzola
    G1 X-12 Y20 F6000       ; inizio zig-zag
    G1 X12 Y22 F4000
    G1 X-12 Y24 F4000
    G1 X12 Y26 F4000
    G1 X-12 Y28 F4000
    G1 X12 Y30 F4000
    G1 X-12 Y32 F4000
    G1 X12 Y34 F4000
    G1 X0 Y35 F4000         ; fine pulizia centrale
    G1 Z5 F1500             ; solleva ugello
    G92 E0                  ; reset estrusore

    M117 Inizio stampa...

[gcode_macro BED_MESH_COREXY_DEFAULT]
description: Calibrazione automatica del bed mesh a 90°C e salvataggio come corexy_default
gcode:
    # Riscaldamento bed
    M140 S90
    M190 S90

    # Homing assi
    G28

    # Calibrazione bed mesh
    BED_MESH_CALIBRATE

    # Salvataggio profilo
    BED_MESH_PROFILE SAVE=corexy_default

    M117 Bed mesh salvato come corexy_default


[gcode_macro PRINT_START]
description: Start stampa con riscaldamento intelligente, pulizia nozzle e caricamento bed mesh
gcode:
    {% set BED_TEMP = params.BED|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER|default(200)|float %}
    {% set BED_TRIGGER = BED_TEMP * 0.8 %}

    # Riscaldamento
    M140 S{BED_TEMP}
    TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={BED_TRIGGER}
    M104 S150
    M190 S{BED_TEMP}
    M109 S{EXTRUDER_TEMP}

    # Homing
    G90
    G28

    # Carica il bed mesh salvato
    BED_MESH_PROFILE LOAD=corexy_default

    # Spurgo e pulizia ugello sulla spazzola
    G92 E0
    G1 X-10 Y15 Z0.3 F6000
    G1 E30 F300
    G92 E0
    G1 Z0.0 F1200
    G1 X0 Y20 F6000
    G1 X10 Y22 F4000
    G1 X-10 Y25 F4000
    G1 X10 Y28 F4000
    G1 X-10 Y31 F4000
    G1 X10 Y34 F4000
    G1 X0 Y35 F4000
    G1 Z5 F1500
    G92 E0

    M117 Inizio stampa...


[gcode_macro PRINT_END]
description: End stampa Voron 2.4 con retrazione, sollevamento e spegnimento
gcode:
    M400                     ; Attendi completamento buffer
    G92 E0                   ; Azzera estrusore
    G1 E-5.0 F300            ; Retrazione
    G91                      ; Coordinate relative
    G1 Z10 F600              ; Solleva ugello
    G90                      ; Coordinate assolute
    G1 X300 Y300 F5000       ; Parcheggia testina
    M104 S0                  ; Spegni hotend
    M140 S0                  ; Spegni bed
    M106 S0                  ; Spegni ventole
    M84                      ; Disattiva motori
    M117 Stampa completata